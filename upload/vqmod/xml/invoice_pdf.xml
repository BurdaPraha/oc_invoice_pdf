<modification>
    <id><![CDATA[Invoice to PDF]]></id>
    <version><![CDATA[1.0.1]]></version>
    <vqmver><![CDATA[1.00]]></vqmver>
    <author><![CDATA[BurdaPraha]]></author>

    <file name="admin/language/cs-cz/cs-cz.php">
        <operation>
            <search position="after"><![CDATA[<?php]]></search>
            <add><![CDATA[$_['button_pdf_invoice']	= 'PDF faktura';]]></add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_invoice.tpl">
        <operation>
            <search position="replace"><![CDATA[<div style="page-break-after: always;">]]></search>
            <add><![CDATA[]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[foreach ($orders as $order) { ?>]]></search>
            <add><![CDATA[$loop=1;
			foreach ($orders as $order) {
			if ($loop < count($orders)){?>
            <div style="page-break-after: always;">
            <?php }else{?>
            <div>
            <?php }?>
            <?php $loop++;?>]]></add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_info.tpl">
        <operation>
            <search position="replace"><![CDATA[<a href="<?php echo $invoice; ?>" target="_blank" data-toggle="tooltip" title="<?php echo $button_invoice_print; ?>" class="btn btn-info"><i class="fa fa-print"></i></a>]]></search>
            <add>
                <![CDATA[
                    <a href="<?php echo $invoice; ?>&pdf=true" target="_blank" data-toggle="tooltip" title="<?php echo $button_pdf_invoice; ?>" class="btn btn-success"><i class="fa fa-file-pdf-o"></i></a> <a href="<?php echo $invoice; ?>" target="_blank" data-toggle="tooltip" title="<?php echo $button_invoice_print; ?>" class="btn btn-info"><i class="fa fa-print"></i></a>
                ]]>
            </add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_list.tpl">
        <operation>
            <search position="after"><![CDATA[<div class="pull-right">]]></search>
            <add>
                <![CDATA[
                    <button type="submit" id="button-pdf" form="form-order" formaction="<?php echo $invoice; ?>&pdf=true" formtarget="_blank" data-toggle="tooltip" class="btn btn-success" title="<?php echo $button_pdf_invoice; ?>"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></button>
                ]]>
            </add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[$('#button-shipping, #button-invoice')]]></search>
            <add><![CDATA[$('#button-shipping, #button-invoice, #button-pdf')]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[if (selected.length) {]]></search>
            <add>
                <![CDATA[$('#button-pdf').prop('disabled', false);]]>
            </add>
        </operation>
    </file>

    <file name="admin/controller/sale/order.php">
        <operation>
            <search position="replace"><![CDATA[public function invoice() {]]></search>
            <add><![CDATA[public function invoice($custom_array = null) {]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[$data['button_invoice_print'] = $this->language->get('button_invoice_print');]]></search>
            <add><![CDATA[$data['button_pdf_invoice'] = $this->language->get('button_pdf_invoice');]]></add>
        </operation>

        <operation>
            <search position="replace"><![CDATA[$orders = array();]]></search>
            <add><![CDATA[

            $orders = array();

            // custom orders ID delivered from argument
            if(isset($custom_array['orders']))
            {
                array_merge($orders, $custom_array['orders']);
            }

            // pdf from administrator request
            $pdf = (isset($this->request->get['pdf'])) ? true : false;
            $return_invoice_path = false;

            ]]>
            </add>
        </operation>

        <operation>
            <search position="replace"><![CDATA[$this->response->setOutput($this->load->view('sale/order_invoice', $data));]]></search>
            <add><![CDATA[

                // return just data for request from catalog
                if(isset($custom_array['return_invoice_path']))
                {
                    $pdf = true;
                    $return_invoice_path = true;
                }

                // print pdf to request from administrator
                if ($pdf)
                {
                    $order_view = $this->load->view('sale/order_invoice', $data);
                    return invoice_pdf($order_view, $data, $return_invoice_path);
                }

                // default response
                if(!isset($custom_array['return_only_data']) && false == $pdf)
                {
                    echo "tady je klasicky vystup";
                    //$this->response->setOutput($this->load->view('sale/order_invoice', $data));
                }

            ]]>
            </add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_invoice.tpl">
        <operation info="support for czech language">
            <search position="before"><![CDATA[</head>]]></search>
            <add>
                <![CDATA[
                    <style>
                      body {
                        font-family: dejavu sans, sans-serif !important;
                      }
                    </style>
                ]]>
            </add>
        </operation>
    </file>


    <file name="admin/controller/startup/login.php,admin/controller/startup/permission.php,admin/controller/user/user_permission.php">
        <operation info="ignore our module for login">
            <search position="after"><![CDATA['common/forgotten',]]></search>
            <add>
                <![CDATA['module/invoicepdf',]]>
            </add>
        </operation>
    </file>


    <file name="system/helper/general.php">
        <operation info="curl function">
            <search position="after"><![CDATA[<?php]]></search>
            <add>
                <![CDATA[
                    if(!function_exists('do_curl_request')){
                        function do_curl_request($url, $params=array()) {
                            $ch = curl_init();
                            curl_setopt($ch,CURLOPT_URL, $url);
                            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                            curl_setopt($ch, CURLOPT_COOKIEJAR, '/tmp/apicookie.txt');
                            curl_setopt($ch, CURLOPT_COOKIEFILE, '/tmp/apicookie.txt');

                            $params_string = '';
                            if (is_array($params) && count($params)) {
                                foreach($params as $key=>$value) {
                                    $params_string .= $key.'='.$value.'&';
                                }
                                rtrim($params_string, '&');

                                curl_setopt($ch,CURLOPT_POST, count($params));
                                curl_setopt($ch,CURLOPT_POSTFIELDS, $params_string);
                            }

                            //execute post
                            $result = curl_exec($ch);

                            //close connection
                            curl_close($ch);

                            return $result;
                        }
                    }
                ]]>
            </add>
        </operation>
    </file>


    <file name="catalog/model/checkout/order.php">

        <operation info="new feature attachment to order history">
            <search position="replace"><![CDATA[public function addOrderHistory($order_id, $order_status_id, $comment = '', $notify = false, $override = false) {]]></search>
            <add>
                <![CDATA[public function addOrderHistory($order_id, $order_status_id, $comment = '', $notify = false, $override = false, $attachment = '') {]]>
            </add>
        </operation>


        <operation info="generate invoice if order status id done">
            <search position="before"><![CDATA[$mail = new Mail();]]></search>
            <add>
                <![CDATA[
                    $success_status_array = array_flip($this->config->get('config_complete_status'));

                    if(array_key_exists($order_status_id, $success_status_array))
                    {
                        // request to generate invoice file
                        $url        = "{$order_info['store_url']}admin/index.php?route=module/invoicepdf&order_id={$order_id}";
                        $request    = do_curl_request($url);
                        $response   = json_decode($request);

                        // add invoice to the mail
                        $attachment = isset($response->path) ? $response->path : '';
                    }
                ]]>
            </add>
        </operation>


        <operation info="new feature attachment to order history">
            <search position="after"><![CDATA[$mail->setText($text);]]></search>
            <add>
                <![CDATA[
                    if(!empty($attachment) && file_exists($attachment)) {
                        $mail->addAttachment($attachment);
                    }
                ]]>
            </add>
        </operation>

    </file>


</modification>