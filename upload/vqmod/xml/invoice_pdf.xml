<modification>
    <id><![CDATA[Invoice to PDF]]></id>
    <version><![CDATA[1.0.1]]></version>
    <vqmver><![CDATA[1.00]]></vqmver>
    <author><![CDATA[BurdaPraha]]></author>

    <file name="admin/language/cs-cz/cs-cz.php">
        <operation>
            <search position="after"><![CDATA[<?php]]></search>
            <add><![CDATA[$_['button_pdf_invoice']	= 'PDF faktura';]]></add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_invoice.tpl">
        <operation>
            <search position="replace"><![CDATA[<div style="page-break-after: always;">]]></search>
            <add><![CDATA[]]></add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[foreach ($orders as $order) { ?>]]></search>
            <add><![CDATA[$loop=1;
			foreach ($orders as $order) {
			if ($loop < count($orders)){?>
            <div style="page-break-after: always;">
            <?php }else{?>
            <div>
            <?php }?>
            <?php $loop++;?>]]></add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_info.tpl">
        <operation>
            <search position="replace"><![CDATA[<a href="<?php echo $invoice; ?>" target="_blank" data-toggle="tooltip" title="<?php echo $button_invoice_print; ?>" class="btn btn-info"><i class="fa fa-print"></i></a>]]></search>
            <add>
                <![CDATA[
                    <a href="<?php echo $invoice; ?>&pdf=true" target="_blank" data-toggle="tooltip" title="<?php echo $button_pdf_invoice; ?>" class="btn btn-success"><i class="fa fa-file-pdf-o"></i></a> <a href="<?php echo $invoice; ?>" target="_blank" data-toggle="tooltip" title="<?php echo $button_invoice_print; ?>" class="btn btn-info"><i class="fa fa-print"></i></a>
                ]]>
            </add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_list.tpl">
        <operation>
            <search position="after"><![CDATA[<div class="pull-right">]]></search>
            <add>
                <![CDATA[
                    <button type="submit" id="button-pdf" form="form-order" formaction="<?php echo $invoice; ?>&pdf=true" formtarget="_blank" data-toggle="tooltip" class="btn btn-success" title="<?php echo $button_pdf_invoice; ?>"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></button>
                ]]>
            </add>
        </operation>
        <operation>
            <search position="replace"><![CDATA[$('#button-shipping, #button-invoice')]]></search>
            <add><![CDATA[$('#button-shipping, #button-invoice, #button-pdf')]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[if (selected.length) {]]></search>
            <add>
                <![CDATA[$('#button-pdf').prop('disabled', false);]]>
            </add>
        </operation>
    </file>

    <file name="admin/controller/sale/order.php">
        <operation>
            <search position="after"><![CDATA[$data['button_invoice_print'] = $this->language->get('button_invoice_print');]]></search>
            <add><![CDATA[$data['button_pdf_invoice'] = $this->language->get('button_pdf_invoice');]]></add>
        </operation>
        <operation>
            <search position="after"><![CDATA[invoice() {]]></search>
            <add><![CDATA[$pdf = false;]]></add>
        </operation>
        <operation>
            <search position="replace" offset="7"><![CDATA[$orders = array();]]></search>
            <add><![CDATA[

            $orders = array();

            if (isset($this->request->post['selected'])) {

                $orders = $this->request->post['selected'];
                $pdf = (isset($this->request->get['pdf'])) ? true : false;

            } elseif (isset($this->request->get['order_id'])) {

                $orders[] = $this->request->get['order_id'];
                $pdf = (isset($this->request->get['pdf'])) ? true : false;

            }
            ]]>
            </add>
        </operation>
        <operation>
            <search position="after"><![CDATA[$this->response->setOutput($this->load->view('sale/order_invoice', $data));]]></search>
            <add><![CDATA[

                if ($pdf)
                {
                    $order_view = $this->load->view('sale/order_invoice', $data);
                    $pdf_printer = invoice_pdf($order_view, $data);
                    $this->response->setOutput();
                }

            ]]>
            </add>
        </operation>
    </file>

    <file name="admin/view/template/sale/order_invoice.tpl">
        <operation info="support for czech language">
            <search position="before"><![CDATA[</head>]]></search>
            <add>
                <![CDATA[
                    <style>
                      body {
                        font-family: dejavu sans, sans-serif !important;
                      }
                    </style>
                ]]>
            </add>
        </operation>
    </file>


    <file name="admin/controller/startup/login.php,admin/controller/startup/permission.php,admin/controller/user/user_permission.php">
        <operation info="ignore our module for login">
            <search position="after"><![CDATA['common/forgotten',]]></search>
            <add>
                <![CDATA['module/invoicepdf',]]>
            </add>
        </operation>
    </file>


    <file name="system/helper/general.php">
        <operation info="curl function">
            <search position="after"><![CDATA[<?php]]></search>
            <add>
                <![CDATA[
                    if(!function_exists('do_curl_request')){
                        function do_curl_request($url, $params=array()) {
                            $ch = curl_init();
                            curl_setopt($ch,CURLOPT_URL, $url);
                            curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
                            curl_setopt($ch, CURLOPT_COOKIEJAR, '/tmp/apicookie.txt');
                            curl_setopt($ch, CURLOPT_COOKIEFILE, '/tmp/apicookie.txt');

                            $params_string = '';
                            if (is_array($params) && count($params)) {
                                foreach($params as $key=>$value) {
                                    $params_string .= $key.'='.$value.'&';
                                }
                                rtrim($params_string, '&');

                                curl_setopt($ch,CURLOPT_POST, count($params));
                                curl_setopt($ch,CURLOPT_POSTFIELDS, $params_string);
                            }

                            //execute post
                            $result = curl_exec($ch);

                            //close connection
                            curl_close($ch);

                            return $result;
                        }
                    }
                ]]>
            </add>
        </operation>
    </file>


    <file name="catalog/model/checkout/order.php">
        <operation info="generate invoice number">
            <search position="before" offset="3"><![CDATA[// Admin Alert Mail]]></search>
            <add>
                <![CDATA[
                    $url = "http://predplatsi.local:8888/admin/index.php?route=module/invoicepdf&order_id={$order_id}";
                    $json = do_curl_request($url, $fields);

                    $invoice = json_decode($json)['invoice'];

                    // add invoice to the mail
                    $mail->addAttachment($invoice);
                ]]>
            </add>
        </operation>
    </file>

</modification>